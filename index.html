<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Information Diving</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				font-family: Monospace;
				background-color: #000;
				color: #fff;
				margin: 0px;
				overflow: hidden;
			}
		</style>
	</head>



	<body>

		<script src="js/three.min.js"></script>

		<script src="js/VRControls.js"></script>
		<script src="js/VREffect.js"></script>

		<script src="js/DeviceOrientationControls.js"></script>
		<script src="js/StereoEffect.js"></script>

		<script src="js/C4DLineLoader.js"></script>

		<script src="js/vrclient.js"></script>

		<script>

			var parameters = ( function () {
				var parameters = {};
				var parts = window.location.search.substr( 1 ).split( '&' );
				for ( var i = 0; i < parts.length; i ++ ) {
					var parameter = parts[ i ].split( '=' );
					parameters[ parameter[ 0 ] ] = parameter[ 1 ];
				}
				return parameters;
			} )();

			var camera, scene, renderer;
			var controls, effect;

			var controls2, clock = new THREE.Clock();

			var sky, water;

			var cameraPath;
			var dolly;

			var loader = new THREE.C4DLineLoader();
			loader.load( 'models/campath-3.txt', function ( line ) {

				cameraPath = line;

			} );

			
			init();
			animate();

			VRClient.ready().then(function() {
				console.log('kicked off ready');
			});

			function init() {

				renderer = new THREE.WebGLRenderer( { antialias: true } );
				renderer.autoClear = false;
				//renderer.setClearColor( 0x404040 );
				document.body.appendChild( renderer.domElement );

				//

				scene = new THREE.Scene();
				scene.fog = new THREE.Fog( 0x00000, -4000, 80000 );
				//scene.fog = new THREE.FogExp2( 0x00000, 0.00025 );

				dolly = new THREE.Object3D();
				dolly.position.set( 500, 500, 500 );
				scene.add( dolly );

				camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 1, 1000000 );
				dolly.add( camera );

				if ( parameters.mode === 'cardboard' ) {

					controls = new THREE.DeviceOrientationControls( camera );
					effect = new THREE.StereoEffect( renderer );

				} else {

					controls = new THREE.VRControls( camera );
					effect = new THREE.VREffect( renderer );

				}

				effect.setSize( window.innerWidth, window.innerHeight );

				document.body.addEventListener( 'dblclick', function () {

					effect.setFullScreen( true );

				} );

				// skybox

				
				var geometry = new THREE.SphereGeometry( 1000, 64, 32 );

				var vertices = geometry.vertices;
				var faces = geometry.faces;

				var colorTop = new THREE.Color( 0xdc72aa );
				var colorMiddle = new THREE.Color( 0xfbdfd3 );
				var colorBottom = new THREE.Color( 0xd7b8b2 );

				for ( var i = 0, l = faces.length; i < l; i ++ ) {

					var face = faces[ i ];

					var vertex1 = vertices[ face.a ];
					var vertex2 = vertices[ face.b ];
					var vertex3 = vertices[ face.c ];

					var color1 = colorMiddle.clone();
					color1.lerp( vertex1.y > 0 ? colorTop : colorBottom, Math.abs( vertex1.y ) / 1000 );

					var color2 = colorMiddle.clone();
					color2.lerp( vertex2.y > 0 ? colorTop : colorBottom, Math.abs( vertex2.y ) / 1000 );

					var color3 = colorMiddle.clone();
					color3.lerp( vertex3.y > 0 ? colorTop : colorBottom, Math.abs( vertex3.y ) / 1000 );

					face.vertexColors.push( color1, color2, color3 );

				}

				var material = new THREE.MeshBasicMaterial( {
					vertexColors: THREE.VertexColors,
					side: THREE.BackSide,
					depthWrite: false,
					depthTest: false,
					fog: false
				} );
				sky = new THREE.Mesh( geometry, material );
				


				
				var geometry = new THREE.SphereGeometry( 10000, 64, 32 )
				geometry.applyMatrix( new THREE.Matrix4().makeScale( -1, 1, 1 ) );
				var material = new THREE.MeshBasicMaterial( { transparent: true, opacity: 1, map: THREE.ImageUtils.loadTexture( 'images/background-2.jpg' ) } );
				sky = new THREE.Mesh( geometry, material );
				scene.add( sky );
				


				//
	//var surface

				var loader = new THREE.ObjectLoader();
				loader.load( 'models/ID-scene-2.json', function ( object ) {

					scene.add( object );

					surface = object.getObjectByName( 'surface', true )
					surface.children[0].material.wireframe = true;
					surface.children[0].material.transparent = true;
					surface.children[0].material.opacity = 0.2;

					

				} );

				// sounds

				/*
				var listener = new THREE.AudioListener();
				camera.add( listener );

				var sound = new THREE.Audio( listener );
				sound.load( 'sounds/78389__inchadney__seagulls.ogg' );
				sound.position.set( 475, 50, 850 );
				sound.setLoop( true );
				sound.setRefDistance( 100 );
				scene.add( sound );

				var sound = new THREE.Audio( listener );
				sound.load( 'sounds/23707__hazure__seagull.ogg' );
				sound.position.set( 10, 50, -200 );
				sound.setLoop( true );
				sound.setRefDistance( 100 );
				scene.add( sound );

				var sound = new THREE.Audio( listener );
				sound.load( 'sounds/235428__allanz10d__calm-ocean-breeze-simulation.ogg' );
				sound.position.set( -30, 0, -750 );
				sound.setLoop( true );
				sound.setRefDistance( 100 );
				scene.add( sound );
				*/

				//

				window.addEventListener( 'resize', onWindowResize, false );

			}

			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				effect.setSize( window.innerWidth, window.innerHeight );

			}

			//

			function animate() {

				requestAnimationFrame( animate );
				render();

			}

			function render() {

				if ( cameraPath !== undefined ) {

					// adjust the number after "performance.now() /" to slow down the animation speed.
					var time = ( performance.now() / 160000 ) % 1;

					var pointA = cameraPath.getPointAt( time );
					var pointB = cameraPath.getPointAt( Math.min( time + 0.015, 1 ) );

					pointA.z = -pointA.z;
					pointB.z = -pointB.z;

					dolly.position.copy( pointA );
					dolly.lookAt( pointB );

					dolly.rotateY( Math.PI ); // look forward

				}

				controls.update();

				//sky.position.copy( dolly.position );

				effect.render( scene, camera );

			}

		</script>

	</body>
</html>
